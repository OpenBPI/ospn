# 开放式社交公共网络IM服务设计方案

由于大多数企业都已经有IM服务正在运行了，因此我们只介绍一些关于改造并接入OSPN网络的解决方案。

## 账户系统的兼容
如果企业已有自己的系统，用户的账户系统需要与OSN账户进行一个映射。映射方式可以是在用户数据库中增加一个字段用以存放OSN账户，也可以另外建立一张映射表。OSN账户我们建议由用户在客户端生成，并由用户提交。

## 处理消息流程

### IMS接收到来自用户的消息的处理
IMS接收到来自用户发出的消息时，可以分两条路线进行，一条是原有系统的路线，另一条是跨界消息路线。IMS接收到来自用户的消息需要进行一段时间的缓存。如果跨界用户一直不来取走这些信息，将一直滞留于IMS，因此我们建议IMS在存储一定时间以后删除掉这些消息，这个存储的时间可以是3天、7天、一个月，根据企业自身的情况进行决定。  

IMS接收到用户消息以后需要进行寻人。我们不建议收到消息立即寻人，而是在消息滞留一段时间以后开始进行寻人，滞留时间建议5到10分钟，同时为了节约资源，再次寻人的命令我们也建议一段时间（5到10分钟）以后再进行。
IMS发送寻人消息请参见osn-connector中的协议文档。或者见我们提供的osn-imsdemo例程。

### IMS接收到寻人指令的处理
IMS同时也会负责接收消息，首先接收到的是来自其他节点的寻人消息。接收到寻人消息以后，IMS会检查该目标用户是否在线，如果不在线则无需做任何回复，不做回复同样可以保护你的用户的隐私。如果用户在线，则发送获取消息源列表的命令给connector。

注：IMS需要维护一个用户经常获取到消息的节点列表。获取消息源列表的指令需要定时发送。
当列表有更新时，需要主动发送消息源表列。

### IMS接收到获取消息源列表请求的处理
IMS会将该用户的所有源列表打包并发送给connector。如果没有则发送空包或者不发送。

### IMS接收到消息源列表的处理
IMS接收到消息源列表就转发给用户，前提是用户在线。如果没有消息则发送空包或者不发送。

### IMS接收到来自用户的获取消息请求的处理
IMS接收到来自自己用户的获取消息请求时，会将其定向转发。

### IMS接收到来自connector的获取消息请求的处理
IMS打包消息并进行发送。已发送消息需要继续滞留在IMS上，因为目前并不确定目标用户是否收到消息，也可能会有多个请求来请求同一消息。

注：IMS发送消息时，也可以将消息源列表附带一起发送。

### IMS接收到消息的处理
IMS接收到消息，验证签名以后转发给用户，如果用户不在可暂时缓存。缓存时间由企业自行决定。 

### IMS收到回执的处理
IMS收到回执以后进行签名校验，并通知自己的用户，然后删除掉消息。  
